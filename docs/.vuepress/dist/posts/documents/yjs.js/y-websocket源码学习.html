<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.49">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" type="image/png" sizes="16x16" href="/img/logo/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/logo/favicon-32x32.png"><link rel="manifest" href="/manifest.webmanifest"><meta name="application-name" content="Gungnir Theme"><meta name="apple-mobile-web-app-title" content="Gungnir Theme"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="apple-touch-icon" href="/img/logo/apple-touch-icon.png"><meta name="theme-color" content="#377bb5"><meta name="msapplication-TileColor" content="#377bb5"><title>y-websocket源码学习 | VuePress Theme Gungnir</title><meta name="description" content="A blog theme for VuePress">
    <link rel="modulepreload" href="/assets/app.544e4f17.js"><link rel="modulepreload" href="/assets/y-websocket源码学习.html.8d7a9a0e.js"><link rel="modulepreload" href="/assets/y-websocket源码学习.html.6966579d.js"><link rel="prefetch" href="/assets/index.html.8e728b2b.js"><link rel="prefetch" href="/assets/Docker快速指南.html.ac905e6d.js"><link rel="prefetch" href="/assets/index.html.be8d703e.js"><link rel="prefetch" href="/assets/analytics.html.32c56d94.js"><link rel="prefetch" href="/assets/comment.html.25089074.js"><link rel="prefetch" href="/assets/hitokoto.html.6dad757a.js"><link rel="prefetch" href="/assets/icons.html.73c5e85d.js"><link rel="prefetch" href="/assets/reading-time.html.fab41476.js"><link rel="prefetch" href="/assets/rss.html.e28391d5.js"><link rel="prefetch" href="/assets/chart.html.eefb8640.js"><link rel="prefetch" href="/assets/math.html.464eda8a.js"><link rel="prefetch" href="/assets/mermaid.html.7212663d.js"><link rel="prefetch" href="/assets/others.html.8ba45ff3.js"><link rel="prefetch" href="/assets/config.html.8b6db3b0.js"><link rel="prefetch" href="/assets/content.html.ac507939.js"><link rel="prefetch" href="/assets/installation.html.f534daad.js"><link rel="prefetch" href="/assets/intro.html.a56462bf.js"><link rel="prefetch" href="/assets/search.html.59941bbf.js"><link rel="prefetch" href="/assets/baidu-tongji.html.a0ec4c3a.js"><link rel="prefetch" href="/assets/chart.html.b8831254.js"><link rel="prefetch" href="/assets/giscus.html.36fcc09c.js"><link rel="prefetch" href="/assets/intro.html.e579195f.js"><link rel="prefetch" href="/assets/katex.html.a5f86b3d.js"><link rel="prefetch" href="/assets/md-plus.html.c31b27ba.js"><link rel="prefetch" href="/assets/mermaid.html.dbcf5bfc.js"><link rel="prefetch" href="/assets/reading-time.html.12efe278.js"><link rel="prefetch" href="/assets/rss.html.ed70d280.js"><link rel="prefetch" href="/assets/Docker快速指南.html.a553c60d.js"><link rel="prefetch" href="/assets/index.html.9fa8b5bf.js"><link rel="prefetch" href="/assets/config.html.3b704857.js"><link rel="prefetch" href="/assets/content.html.4753bf58.js"><link rel="prefetch" href="/assets/installation.html.e89e9cac.js"><link rel="prefetch" href="/assets/intro.html.a29ebba3.js"><link rel="prefetch" href="/assets/search.html.f998dc7a.js"><link rel="prefetch" href="/assets/analytics.html.c5b4ca5a.js"><link rel="prefetch" href="/assets/comment.html.95c12868.js"><link rel="prefetch" href="/assets/hitokoto.html.75724958.js"><link rel="prefetch" href="/assets/icons.html.51d2fb15.js"><link rel="prefetch" href="/assets/reading-time.html.08707a39.js"><link rel="prefetch" href="/assets/rss.html.e5db539e.js"><link rel="prefetch" href="/assets/deploy.html.004cb244.js"><link rel="prefetch" href="/assets/resource.html.27d6eef8.js"><link rel="prefetch" href="/assets/chart.html.a37f0ad0.js"><link rel="prefetch" href="/assets/math.html.4553c0fc.js"><link rel="prefetch" href="/assets/mermaid.html.ea72386e.js"><link rel="prefetch" href="/assets/others.html.f912a6a6.js"><link rel="prefetch" href="/assets/backend.html.e3e32b23.js"><link rel="prefetch" href="/assets/hooks.html.06639c25.js"><link rel="prefetch" href="/assets/Monitoring State.html.da36f62b.js"><link rel="prefetch" href="/assets/index.html.96d06e5d.js"><link rel="prefetch" href="/assets/介绍.html.aaa3b026.js"><link rel="prefetch" href="/assets/概览.html.ebb98660.js"><link rel="prefetch" href="/assets/组件.html.66ed6481.js"><link rel="prefetch" href="/assets/index.html.ca184ad4.js"><link rel="prefetch" href="/assets/The sx prop.html.9ec9c1ea.js"><link rel="prefetch" href="/assets/用法.html.2a24386c.js"><link rel="prefetch" href="/assets/起步.html.38f2f5d3.js"><link rel="prefetch" href="/assets/index.html.b59f63c7.js"><link rel="prefetch" href="/assets/Delta Format.html.7d61297c.js"><link rel="prefetch" href="/assets/Document Updates.html.37a9ec78.js"><link rel="prefetch" href="/assets/index.html.9b1d906d.js"><link rel="prefetch" href="/assets/Shared Types.html.953121a6.js"><link rel="prefetch" href="/assets/y-protocol源码学习.html.d2978e18.js"><link rel="prefetch" href="/assets/Y.Doc.html.5c9c389b.js"><link rel="prefetch" href="/assets/Y.Event.html.20b4d468.js"><link rel="prefetch" href="/assets/Y.UndoManager.html.4e8e2a77.js"><link rel="prefetch" href="/assets/基础概念.html.efe25383.js"><link rel="prefetch" href="/assets/网络同步.html.7b075fc2.js"><link rel="prefetch" href="/assets/baidu-tongji.html.7cd7fdc2.js"><link rel="prefetch" href="/assets/chart.html.829894df.js"><link rel="prefetch" href="/assets/giscus.html.6630bfa1.js"><link rel="prefetch" href="/assets/intro.html.9c9082c7.js"><link rel="prefetch" href="/assets/katex.html.9b98c34d.js"><link rel="prefetch" href="/assets/md-plus.html.ef8b1ddb.js"><link rel="prefetch" href="/assets/mermaid.html.2abfeafa.js"><link rel="prefetch" href="/assets/reading-time.html.94bed6ee.js"><link rel="prefetch" href="/assets/rss.html.8d94c32a.js"><link rel="prefetch" href="/assets/index.html.ba9386bb.js"><link rel="prefetch" href="/assets/The sx prop.html.5ad91fee.js"><link rel="prefetch" href="/assets/用法.html.4e134c4b.js"><link rel="prefetch" href="/assets/起步.html.a9ec1eb3.js"><link rel="prefetch" href="/assets/Delta Format.html.283ecf2c.js"><link rel="prefetch" href="/assets/Document Updates.html.73bd8ce5.js"><link rel="prefetch" href="/assets/index.html.108f738a.js"><link rel="prefetch" href="/assets/Shared Types.html.34d0870f.js"><link rel="prefetch" href="/assets/y-protocol源码学习.html.67af4840.js"><link rel="prefetch" href="/assets/y-websocket源码学习.html.430ebee8.js"><link rel="prefetch" href="/assets/Y.Doc.html.ed84e69c.js"><link rel="prefetch" href="/assets/Y.Event.html.9e13bcd8.js"><link rel="prefetch" href="/assets/Y.UndoManager.html.c735bdf9.js"><link rel="prefetch" href="/assets/基础概念.html.91d1abd6.js"><link rel="prefetch" href="/assets/网络同步.html.3cecb49d.js"><link rel="prefetch" href="/assets/backend.html.c9d776db.js"><link rel="prefetch" href="/assets/hooks.html.36146126.js"><link rel="prefetch" href="/assets/Monitoring State.html.c0c2d941.js"><link rel="prefetch" href="/assets/index.html.c2288129.js"><link rel="prefetch" href="/assets/介绍.html.4950c845.js"><link rel="prefetch" href="/assets/概览.html.6cf25757.js"><link rel="prefetch" href="/assets/组件.html.8669dbc7.js"><link rel="prefetch" href="/assets/404.html.d341cb57.js"><link rel="prefetch" href="/assets/index.html.7e9be091.js"><link rel="prefetch" href="/assets/index.html.d080f048.js"><link rel="prefetch" href="/assets/index.html.3c25d619.js"><link rel="prefetch" href="/assets/index.html.140f8688.js"><link rel="prefetch" href="/assets/index.html.fb11d93a.js"><link rel="prefetch" href="/assets/index.html.b28ff175.js"><link rel="prefetch" href="/assets/index.html.d97d7b35.js"><link rel="prefetch" href="/assets/index.html.44638413.js"><link rel="prefetch" href="/assets/index.html.d32216d6.js"><link rel="prefetch" href="/assets/index.html.305c60ac.js"><link rel="prefetch" href="/assets/Docker快速指南.html.6005227f.js"><link rel="prefetch" href="/assets/index.html.9836eebc.js"><link rel="prefetch" href="/assets/analytics.html.312671ce.js"><link rel="prefetch" href="/assets/comment.html.0e21fc9a.js"><link rel="prefetch" href="/assets/hitokoto.html.616306b3.js"><link rel="prefetch" href="/assets/icons.html.34ed8a94.js"><link rel="prefetch" href="/assets/reading-time.html.65579be9.js"><link rel="prefetch" href="/assets/rss.html.48126d45.js"><link rel="prefetch" href="/assets/chart.html.8793aee6.js"><link rel="prefetch" href="/assets/math.html.d7d51718.js"><link rel="prefetch" href="/assets/mermaid.html.61798a59.js"><link rel="prefetch" href="/assets/others.html.be3134b8.js"><link rel="prefetch" href="/assets/config.html.9c74d659.js"><link rel="prefetch" href="/assets/content.html.5ff76501.js"><link rel="prefetch" href="/assets/installation.html.05446ffa.js"><link rel="prefetch" href="/assets/intro.html.0e78233d.js"><link rel="prefetch" href="/assets/search.html.93212ed9.js"><link rel="prefetch" href="/assets/baidu-tongji.html.976c11b8.js"><link rel="prefetch" href="/assets/chart.html.029ee747.js"><link rel="prefetch" href="/assets/giscus.html.974c550f.js"><link rel="prefetch" href="/assets/intro.html.5c0ed8d2.js"><link rel="prefetch" href="/assets/katex.html.320ec9d4.js"><link rel="prefetch" href="/assets/md-plus.html.8e411251.js"><link rel="prefetch" href="/assets/mermaid.html.f1c89c8f.js"><link rel="prefetch" href="/assets/reading-time.html.ba5d87a7.js"><link rel="prefetch" href="/assets/rss.html.0399564f.js"><link rel="prefetch" href="/assets/Docker快速指南.html.e94d3a06.js"><link rel="prefetch" href="/assets/index.html.faf888e8.js"><link rel="prefetch" href="/assets/config.html.a06f98ff.js"><link rel="prefetch" href="/assets/content.html.42f97c2c.js"><link rel="prefetch" href="/assets/installation.html.a5d459a4.js"><link rel="prefetch" href="/assets/intro.html.c90e2270.js"><link rel="prefetch" href="/assets/search.html.88795650.js"><link rel="prefetch" href="/assets/analytics.html.00df7cb2.js"><link rel="prefetch" href="/assets/comment.html.62026c3c.js"><link rel="prefetch" href="/assets/hitokoto.html.56122234.js"><link rel="prefetch" href="/assets/icons.html.4cbf6940.js"><link rel="prefetch" href="/assets/reading-time.html.1005b636.js"><link rel="prefetch" href="/assets/rss.html.d740eaf9.js"><link rel="prefetch" href="/assets/deploy.html.d39fbe76.js"><link rel="prefetch" href="/assets/resource.html.ad32ba37.js"><link rel="prefetch" href="/assets/chart.html.d9259f88.js"><link rel="prefetch" href="/assets/math.html.268bab12.js"><link rel="prefetch" href="/assets/mermaid.html.305f6a68.js"><link rel="prefetch" href="/assets/others.html.3ea30c96.js"><link rel="prefetch" href="/assets/backend.html.e716e5b9.js"><link rel="prefetch" href="/assets/hooks.html.df87895c.js"><link rel="prefetch" href="/assets/Monitoring State.html.8d63d393.js"><link rel="prefetch" href="/assets/index.html.b0b6014d.js"><link rel="prefetch" href="/assets/介绍.html.d2939b96.js"><link rel="prefetch" href="/assets/概览.html.5293f564.js"><link rel="prefetch" href="/assets/组件.html.9dac5f59.js"><link rel="prefetch" href="/assets/index.html.8b7b0b84.js"><link rel="prefetch" href="/assets/The sx prop.html.c9a699eb.js"><link rel="prefetch" href="/assets/用法.html.8663a89c.js"><link rel="prefetch" href="/assets/起步.html.5a25b6a3.js"><link rel="prefetch" href="/assets/index.html.08f7cedb.js"><link rel="prefetch" href="/assets/Delta Format.html.08212c72.js"><link rel="prefetch" href="/assets/Document Updates.html.47ffcdd4.js"><link rel="prefetch" href="/assets/index.html.c1bbf76e.js"><link rel="prefetch" href="/assets/Shared Types.html.dd35a926.js"><link rel="prefetch" href="/assets/y-protocol源码学习.html.4861cf45.js"><link rel="prefetch" href="/assets/Y.Doc.html.578c67e8.js"><link rel="prefetch" href="/assets/Y.Event.html.c755a69c.js"><link rel="prefetch" href="/assets/Y.UndoManager.html.6c345284.js"><link rel="prefetch" href="/assets/基础概念.html.dcc071df.js"><link rel="prefetch" href="/assets/网络同步.html.ea60430a.js"><link rel="prefetch" href="/assets/baidu-tongji.html.ca9c61e4.js"><link rel="prefetch" href="/assets/chart.html.0c30dc92.js"><link rel="prefetch" href="/assets/giscus.html.0d8cb9a5.js"><link rel="prefetch" href="/assets/intro.html.d6586be7.js"><link rel="prefetch" href="/assets/katex.html.c21ab458.js"><link rel="prefetch" href="/assets/md-plus.html.84d2e324.js"><link rel="prefetch" href="/assets/mermaid.html.e649900e.js"><link rel="prefetch" href="/assets/reading-time.html.581de004.js"><link rel="prefetch" href="/assets/rss.html.36c6c6f4.js"><link rel="prefetch" href="/assets/index.html.5ebb42eb.js"><link rel="prefetch" href="/assets/The sx prop.html.5fff5a56.js"><link rel="prefetch" href="/assets/用法.html.cfa8e110.js"><link rel="prefetch" href="/assets/起步.html.3662324d.js"><link rel="prefetch" href="/assets/Delta Format.html.ac3a65a9.js"><link rel="prefetch" href="/assets/Document Updates.html.014c20a2.js"><link rel="prefetch" href="/assets/index.html.db048a57.js"><link rel="prefetch" href="/assets/Shared Types.html.38566ea3.js"><link rel="prefetch" href="/assets/y-protocol源码学习.html.072bb841.js"><link rel="prefetch" href="/assets/y-websocket源码学习.html.48498e9a.js"><link rel="prefetch" href="/assets/Y.Doc.html.ab7592d8.js"><link rel="prefetch" href="/assets/Y.Event.html.5f100808.js"><link rel="prefetch" href="/assets/Y.UndoManager.html.64366830.js"><link rel="prefetch" href="/assets/基础概念.html.accfad33.js"><link rel="prefetch" href="/assets/网络同步.html.ddebbe3c.js"><link rel="prefetch" href="/assets/backend.html.f2044f20.js"><link rel="prefetch" href="/assets/hooks.html.b5eeed87.js"><link rel="prefetch" href="/assets/Monitoring State.html.269e6590.js"><link rel="prefetch" href="/assets/index.html.a41cc55c.js"><link rel="prefetch" href="/assets/介绍.html.7819374c.js"><link rel="prefetch" href="/assets/概览.html.3dee9e80.js"><link rel="prefetch" href="/assets/组件.html.d535a279.js"><link rel="prefetch" href="/assets/404.html.2f4e5b1f.js"><link rel="prefetch" href="/assets/index.html.f056ae31.js"><link rel="prefetch" href="/assets/index.html.01d96488.js"><link rel="prefetch" href="/assets/index.html.5fff8c0d.js"><link rel="prefetch" href="/assets/index.html.d4a516c4.js"><link rel="prefetch" href="/assets/index.html.0d249669.js"><link rel="prefetch" href="/assets/index.html.ec226aa4.js"><link rel="prefetch" href="/assets/index.html.2e8d4898.js"><link rel="prefetch" href="/assets/index.html.81a76731.js"><link rel="prefetch" href="/assets/index.html.1beacac8.js"><link rel="prefetch" href="/assets/404.f7c3bfe7.js"><link rel="prefetch" href="/assets/HomePage.23170c1d.js"><link rel="prefetch" href="/assets/Layout.600b6979.js"><link rel="prefetch" href="/assets/Links.4c6c9d46.js"><link rel="prefetch" href="/assets/Post.de319c30.js"><link rel="prefetch" href="/assets/Tags.736a7362.js">
    <link rel="stylesheet" href="/assets/style.bf1d5085.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar is-fixed is-visible invert"><span><a href="/" class=""><span class="site-name">Align</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M489.2 287.9h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6V146.2c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6v-32c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6v-32c0-6-8-4.6-11.7-4.6v-38c8.3-2 17.1-3.4 25.7-3.4 10.9 0 20.9 4.3 31.4 4.3 4.6 0 27.7-1.1 27.7-8v-60c0-2.6-2-4.6-4.6-4.6-5.1 0-15.1 4.3-24 4.3-9.7 0-20.9-4.3-32.6-4.3-8 0-16 1.1-23.7 2.9v-4.9c5.4-2.6 9.1-8.3 9.1-14.3 0-20.7-31.4-20.8-31.4 0 0 6 3.7 11.7 9.1 14.3v111.7c-3.7 0-11.7-1.4-11.7 4.6v32h-36.6v-32c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32H128v-32c0-2.6-2-4.6-4.6-4.6H96c-2.6 0-4.6 2-4.6 4.6v178.3H54.8v-32c0-2.6-2-4.6-4.6-4.6H22.8c-2.6 0-4.6 2-4.6 4.6V512h182.9v-96c0-72.6 109.7-72.6 109.7 0v96h182.9V292.5c.1-2.6-1.9-4.6-4.5-4.6zm-288.1-4.5c0 2.6-2 4.6-4.6 4.6h-27.4c-2.6 0-4.6-2-4.6-4.6v-64c0-2.6 2-4.6 4.6-4.6h27.4c2.6 0 4.6 2 4.6 4.6v64zm146.4 0c0 2.6-2 4.6-4.6 4.6h-27.4c-2.6 0-4.6-2-4.6-4.6v-64c0-2.6 2-4.6 4.6-4.6h27.4c2.6 0 4.6 2 4.6 4.6v64z"/></svg></span><span>Home</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/tags/" class="" aria-label="Tags"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg></span><span>Tags</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/links/" class="" aria-label="Links"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M305.45 462.59c7.391 7.298 6.188 20.097-3 25.004-77.714 41.802-176.726 29.91-242.344-35.709-65.602-65.603-77.51-164.523-35.692-242.331 4.891-9.095 17.69-10.298 25.003-3l116.812 116.813 27.394-27.394c-.688-2.61-1.594-5.001-1.594-7.814a32.004 32.004 0 1132.004 32.005c-2.797 0-5.204-.891-7.798-1.594l-27.41 27.41zm206.526-159.523a16.103 16.103 0 01-16.002 17.003H463.86a15.97 15.97 0 01-15.892-15.002C440.467 175.549 336.453 70.534 207.03 63.533a15.845 15.845 0 01-15.002-15.908V16.027A16.094 16.094 0 01209.03.024C372.255 8.62 503.475 139.841 511.976 303.067zm-96.012-.297a16.21 16.21 0 01-16.112 17.3h-32.207a16.069 16.069 0 01-15.893-14.705c-6.907-77.011-68.118-138.91-144.924-145.224a15.94 15.94 0 01-14.8-15.893v-32.114a16.134 16.134 0 0117.3-16.096c110.123 8.501 198.228 96.607 206.636 206.732z"/></svg></span><span>Links</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/posts/readme.md" class="" aria-label="Posts"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M20 22H4a1 1 0 01-1-1V3a1 1 0 011-1h16a1 1 0 011 1v18a1 1 0 01-1 1zm-1-2V4H5v16h14zM7 6h4v4H7V6zm0 6h10v2H7v-2zm0 4h10v2H7v-2zm6-9h4v2h-4V7z"/></svg></span><span>Posts</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/docs/basic/intro.md" class="" aria-label="DevDocs"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M21 18H6a1 1 0 000 2h15v2H6a3 3 0 01-3-3V4a2 2 0 012-2h16v16zm-5-9V7H8v2h8z"/></svg></span><span>DevDocs</span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://v2.vuepress.vuejs.org/" rel="noopener noreferrer" target="_blank" aria-label="VuePress"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M3.316 3L12 18l8.684-15H23L12 22 1 3h2.316zm4.342 0L12 10.5 16.342 3h2.316L12 14.5 5.342 3h2.316z"/></svg></span><span>VuePress</span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title"><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/></svg></span><span>Languages</span></span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title"><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/></svg></span><span>Languages</span></span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--><!----><span>English</span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html" class="" aria-label="简体中文"><!--[--><!--]--><!----><span>简体中文</span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--><div class="navbar-item"><a style="cursor:pointer;"><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 2c4.968 0 9 4.032 9 9s-4.032 9-9 9-9-4.032-9-9 4.032-9 9-9zm0 16c3.867 0 7-3.133 7-7 0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7zm8.485.071l2.829 2.828-1.415 1.415-2.828-2.829 1.414-1.414z"/></svg></span><span>Search</span></a></div></nav><!--[--><!--]--><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M489.2 287.9h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6V146.2c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6v-32c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6v-32c0-6-8-4.6-11.7-4.6v-38c8.3-2 17.1-3.4 25.7-3.4 10.9 0 20.9 4.3 31.4 4.3 4.6 0 27.7-1.1 27.7-8v-60c0-2.6-2-4.6-4.6-4.6-5.1 0-15.1 4.3-24 4.3-9.7 0-20.9-4.3-32.6-4.3-8 0-16 1.1-23.7 2.9v-4.9c5.4-2.6 9.1-8.3 9.1-14.3 0-20.7-31.4-20.8-31.4 0 0 6 3.7 11.7 9.1 14.3v111.7c-3.7 0-11.7-1.4-11.7 4.6v32h-36.6v-32c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32H128v-32c0-2.6-2-4.6-4.6-4.6H96c-2.6 0-4.6 2-4.6 4.6v178.3H54.8v-32c0-2.6-2-4.6-4.6-4.6H22.8c-2.6 0-4.6 2-4.6 4.6V512h182.9v-96c0-72.6 109.7-72.6 109.7 0v96h182.9V292.5c.1-2.6-1.9-4.6-4.5-4.6zm-288.1-4.5c0 2.6-2 4.6-4.6 4.6h-27.4c-2.6 0-4.6-2-4.6-4.6v-64c0-2.6 2-4.6 4.6-4.6h27.4c2.6 0 4.6 2 4.6 4.6v64zm146.4 0c0 2.6-2 4.6-4.6 4.6h-27.4c-2.6 0-4.6-2-4.6-4.6v-64c0-2.6 2-4.6 4.6-4.6h27.4c2.6 0 4.6 2 4.6 4.6v64z"/></svg></span><span>Home</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/tags/" class="" aria-label="Tags"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg></span><span>Tags</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/links/" class="" aria-label="Links"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M305.45 462.59c7.391 7.298 6.188 20.097-3 25.004-77.714 41.802-176.726 29.91-242.344-35.709-65.602-65.603-77.51-164.523-35.692-242.331 4.891-9.095 17.69-10.298 25.003-3l116.812 116.813 27.394-27.394c-.688-2.61-1.594-5.001-1.594-7.814a32.004 32.004 0 1132.004 32.005c-2.797 0-5.204-.891-7.798-1.594l-27.41 27.41zm206.526-159.523a16.103 16.103 0 01-16.002 17.003H463.86a15.97 15.97 0 01-15.892-15.002C440.467 175.549 336.453 70.534 207.03 63.533a15.845 15.845 0 01-15.002-15.908V16.027A16.094 16.094 0 01209.03.024C372.255 8.62 503.475 139.841 511.976 303.067zm-96.012-.297a16.21 16.21 0 01-16.112 17.3h-32.207a16.069 16.069 0 01-15.893-14.705c-6.907-77.011-68.118-138.91-144.924-145.224a15.94 15.94 0 01-14.8-15.893v-32.114a16.134 16.134 0 0117.3-16.096c110.123 8.501 198.228 96.607 206.636 206.732z"/></svg></span><span>Links</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/posts/readme.md" class="" aria-label="Posts"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M20 22H4a1 1 0 01-1-1V3a1 1 0 011-1h16a1 1 0 011 1v18a1 1 0 01-1 1zm-1-2V4H5v16h14zM7 6h4v4H7V6zm0 6h10v2H7v-2zm0 4h10v2H7v-2zm6-9h4v2h-4V7z"/></svg></span><span>Posts</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/docs/basic/intro.md" class="" aria-label="DevDocs"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M21 18H6a1 1 0 000 2h15v2H6a3 3 0 01-3-3V4a2 2 0 012-2h16v16zm-5-9V7H8v2h8z"/></svg></span><span>DevDocs</span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://v2.vuepress.vuejs.org/" rel="noopener noreferrer" target="_blank" aria-label="VuePress"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M3.316 3L12 18l8.684-15H23L12 22 1 3h2.316zm4.342 0L12 10.5 16.342 3h2.316L12 14.5 5.342 3h2.316z"/></svg></span><span>VuePress</span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title"><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/></svg></span><span>Languages</span></span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title"><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/></svg></span><span>Languages</span></span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--><!----><span>English</span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html" class="" aria-label="简体中文"><!--[--><!--]--><!----><span>简体中文</span><!--[--><!--]--></a></li><!--]--></ul></div></div><!--]--><div class="navbar-item"><a style="cursor:pointer;"><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 2c4.968 0 9 4.032 9 9s-4.032 9-9 9-9-4.032-9-9 4.032-9 9-9zm0 16c3.867 0 7-3.133 7-7 0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7zm8.485.071l2.829 2.828-1.415 1.415-2.828-2.829 1.414-1.414z"/></svg></span><span>Search</span></a></div></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Intro <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/posts/" class="router-link-active sidebar-item" aria-label="Introd"><!--[--><!--]--><!----><span>Introd</span><!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">yjs.js <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/posts/documents/yjs.js/%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5.html" class="sidebar-item" aria-label="基础概念"><!--[--><!--]--><!----><span>基础概念</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/yjs.js/%E7%BD%91%E7%BB%9C%E5%90%8C%E6%AD%A5.html" class="sidebar-item" aria-label="网络同步"><!--[--><!--]--><!----><span>网络同步</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/yjs.js/Y.Doc.html" class="sidebar-item" aria-label="Y.Doc"><!--[--><!--]--><!----><span>Y.Doc</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/yjs.js/Shared%20Types.html" class="sidebar-item" aria-label="Shared Types"><!--[--><!--]--><!----><span>Shared Types</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/yjs.js/Delta%20Format.html" class="sidebar-item" aria-label="Delta Format"><!--[--><!--]--><!----><span>Delta Format</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/yjs.js/Y.Event.html" class="sidebar-item" aria-label="Y.Event"><!--[--><!--]--><!----><span>Y.Event</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/yjs.js/Y.UndoManager.html" class="sidebar-item" aria-label="Y.UndoManager"><!--[--><!--]--><!----><span>Y.UndoManager</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/yjs.js/Document%20Updates.html" class="sidebar-item" aria-label="Document Updates"><!--[--><!--]--><!----><span>Document Updates</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/yjs.js/y-protocol%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html" class="sidebar-item" aria-label="y-protocol源码学习"><!--[--><!--]--><!----><span>y-protocol源码学习</span><!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="y-websocket源码学习"><!--[--><!--]--><!----><span>y-websocket源码学习</span><!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#初始化对象" class="router-link-active router-link-exact-active sidebar-item" aria-label="初始化对象"><!--[--><!--]--><!----><span>初始化对象</span><!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#初始化连接-connect" class="router-link-active router-link-exact-active sidebar-item" aria-label="初始化连接(connect)"><!--[--><!--]--><!----><span>初始化连接(connect)</span><!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#setupws" class="router-link-active router-link-exact-active sidebar-item" aria-label="setupWS"><!--[--><!--]--><!----><span>setupWS</span><!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#connectbc" class="router-link-active router-link-exact-active sidebar-item" aria-label="connectBc"><!--[--><!--]--><!----><span>connectBc</span><!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#关闭连接-disconnect" class="router-link-active router-link-exact-active sidebar-item" aria-label="关闭连接(disconnect)"><!--[--><!--]--><!----><span>关闭连接(disconnect)</span><!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#disconnectbc" class="router-link-active router-link-exact-active sidebar-item" aria-label="disconnectBc"><!--[--><!--]--><!----><span>disconnectBc</span><!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#活动事件" class="router-link-active router-link-exact-active sidebar-item" aria-label="活动事件"><!--[--><!--]--><!----><span>活动事件</span><!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#消息接受-onmessage" class="router-link-active router-link-exact-active sidebar-item" aria-label="消息接受(onmessage)"><!--[--><!--]--><!----><span>消息接受(onmessage)</span><!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#连接成功-onopen" class="router-link-active router-link-exact-active sidebar-item" aria-label="连接成功(onopen)"><!--[--><!--]--><!----><span>连接成功(onopen)</span><!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#连接关闭-onclose" class="router-link-active router-link-exact-active sidebar-item" aria-label="连接关闭(onclose)"><!--[--><!--]--><!----><span>连接关闭(onclose)</span><!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#usages" class="router-link-active router-link-exact-active sidebar-item" aria-label="Usages"><!--[--><!--]--><!----><span>Usages</span><!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#status-event" class="router-link-active router-link-exact-active sidebar-item" aria-label="status Event"><!--[--><!--]--><!----><span>status Event</span><!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/posts/documents/yjs.js/y-websocket%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html#synced-getter" class="router-link-active router-link-exact-active sidebar-item" aria-label="synced Getter"><!--[--><!--]--><!----><span>synced Getter</span><!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">react-dnd <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/posts/documents/reactDnd/%E4%BB%8B%E7%BB%8D.html" class="sidebar-item" aria-label="介绍"><!--[--><!--]--><!----><span>介绍</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/reactDnd/%E6%A6%82%E8%A7%88.html" class="sidebar-item" aria-label="概览"><!--[--><!--]--><!----><span>概览</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/reactDnd/%E7%BB%84%E4%BB%B6.html" class="sidebar-item" aria-label="组件"><!--[--><!--]--><!----><span>组件</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/reactDnd/hooks.html" class="sidebar-item" aria-label="hooks"><!--[--><!--]--><!----><span>hooks</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/reactDnd/Monitoring%20State.html" class="sidebar-item" aria-label="Monitoring State.md"><!--[--><!--]--><!----><span>Monitoring State.md</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/reactDnd/backend.html" class="sidebar-item" aria-label="backend"><!--[--><!--]--><!----><span>backend</span><!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading">MUI Systom <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/posts/documents/MUI%20System/%E8%B5%B7%E6%AD%A5.html" class="sidebar-item" aria-label="起步"><!--[--><!--]--><!----><span>起步</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/MUI%20System/%E7%94%A8%E6%B3%95.html" class="sidebar-item" aria-label="用法"><!--[--><!--]--><!----><span>用法</span><!--[--><!--]--></a><!----></li><li><a href="/posts/documents/MUI%20System/The%20sx%20prop.html" class="sidebar-item" aria-label="The sx prop"><!--[--><!--]--><!----><span>The sx prop</span><!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><div class="page-content"><!--[--><main class="page"><!--[--><div class="article-header" style=""><!----><div class="article-header-content"><!----><h1 class="article-title">y-websocket源码学习</h1><!----><div class="article-icons"><div class="article-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M313.6 304c-28.7 0-42.5 16-89.6 16-47.1 0-60.8-16-89.6-16C60.2 304 0 364.2 0 438.4V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48v-25.6c0-74.2-60.2-134.4-134.4-134.4zM400 464H48v-25.6c0-47.6 38.8-86.4 86.4-86.4 14.6 0 38.3 16 89.6 16 51.7 0 74.9-16 89.6-16 47.6 0 86.4 38.8 86.4 86.4V464zM224 288c79.5 0 144-64.5 144-144S303.5 0 224 0 80 64.5 80 144s64.5 144 144 144zm0-240c52.9 0 96 43.1 96 96s-43.1 96-96 96-96-43.1-96-96 43.1-96 96-96z"/></svg><span>Align</span></div><div class="article-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M400 64h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zm-6 400H54c-3.3 0-6-2.7-6-6V160h352v298c0 3.3-2.7 6-6 6z"/></svg><span>2023-09-15</span></div><div class="article-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M17.618 5.968l1.453-1.453 1.414 1.414-1.453 1.453a9 9 0 11-1.414-1.414zM12 20a7 7 0 100-14 7 7 0 000 14zM11 8h2v6h-2V8zM8 1h8v2H8V1z"/></svg><span>16 min</span></div></div></div><!----></div><!--[--><!--]--><!--]--><div class="theme-gungnir-content"><!--[--><!--]--><div><p>官方的同步示例我觉得还是很有参考价值的，值得深入学习下，所以这里扒了下源码。需要注意的是这里面涉及到了<a href="/posts/documents/yjs.js/%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5.html" class="">yjs</a>和<a href="/posts/documents/yjs.js/y-protocol%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html" class="">y-protocols</a>。请务必先了解这两个库。</p><details class="custom-container details"><summary>点击查看源码</summary><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@module</span> provider/websocket
 */</span>

<span class="token comment">/* eslint-env browser */</span>

<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span> <span class="token comment">// eslint-disable-line</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> bc <span class="token keyword">from</span> <span class="token string">&#39;lib0/broadcastchannel.js&#39;</span> <span class="token comment">//基于localstore实现的跨标签通信。</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> time <span class="token keyword">from</span> <span class="token string">&#39;lib0/time.js&#39;</span><span class="token comment">//时间模块</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> encoding <span class="token keyword">from</span> <span class="token string">&#39;lib0/encoding.js&#39;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> decoding <span class="token keyword">from</span> <span class="token string">&#39;lib0/decoding.js&#39;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> syncProtocol <span class="token keyword">from</span> <span class="token string">&#39;y-protocols/sync.js&#39;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> authProtocol <span class="token keyword">from</span> <span class="token string">&#39;y-protocols/auth.js&#39;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> awarenessProtocol <span class="token keyword">from</span> <span class="token string">&#39;y-protocols/awareness.js&#39;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> mutex <span class="token keyword">from</span> <span class="token string">&#39;lib0/mutex.js&#39;</span><span class="token comment">//互斥锁模块</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;lib0/observable.js&#39;</span> <span class="token comment">//观察者模块</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> math <span class="token keyword">from</span> <span class="token string">&#39;lib0/math.js&#39;</span> <span class="token comment">//数学模块</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> url <span class="token keyword">from</span> <span class="token string">&#39;lib0/url.js&#39;</span> <span class="token comment">//url模块 </span>

<span class="token comment">//消息同步操作</span>
<span class="token keyword">const</span> messageSync <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> messageQueryAwareness <span class="token operator">=</span> <span class="token number">3</span>
<span class="token keyword">const</span> messageAwareness <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">const</span> messageAuth <span class="token operator">=</span> <span class="token number">2</span>

<span class="token keyword">const</span> reconnectTimeoutBase <span class="token operator">=</span> <span class="token number">1200</span>
<span class="token keyword">const</span> maxReconnectTimeout <span class="token operator">=</span> <span class="token number">2500</span>
<span class="token comment">// @todo - this should depend on awareness.outdatedTime</span>
<span class="token keyword">const</span> messageReconnectTimeout <span class="token operator">=</span> <span class="token number">30000</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 协议连接被拒绝的处理函数
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>WebsocketProvider<span class="token punctuation">}</span></span> <span class="token parameter">provider</span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">reason</span>
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">permissionDeniedHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">provider<span class="token punctuation">,</span> reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Permission denied to access </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>provider<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 读取收到消息
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>WebsocketProvider<span class="token punctuation">}</span></span> <span class="token parameter">provider</span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Uint8Array<span class="token punctuation">}</span></span> <span class="token parameter">buf</span> 通信数据
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>boolean<span class="token punctuation">}</span></span> <span class="token parameter">emitSynced</span> 是否来自远程的消息
 * <span class="token keyword">@return</span> <span class="token class-name"><span class="token punctuation">{</span>encoding<span class="token punctuation">.</span>Encoder<span class="token punctuation">}</span></span>
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">readMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">provider<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> emitSynced</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//基于数据构建解码器</span>
  <span class="token keyword">const</span> decoder <span class="token operator">=</span> decoding<span class="token punctuation">.</span><span class="token function">createDecoder</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
  <span class="token comment">//创建编码器</span>
  <span class="token keyword">const</span> encoder <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">//获取消息类型(websocket层协议)</span>
  <span class="token keyword">const</span> messageType <span class="token operator">=</span> decoding<span class="token punctuation">.</span><span class="token function">readVarUint</span><span class="token punctuation">(</span>decoder<span class="token punctuation">)</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>messageType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">messageSync</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//是消息同步操作</span>
      <span class="token comment">//编码消息类型</span>
      encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> messageSync<span class="token punctuation">)</span>
      <span class="token comment">//获取消息类型(protocol层协议)</span>
      <span class="token comment">/*
      * 该方法执行:
      * 1.是step1消息，接受到的数据是远程文档状态的向量，将本地文档状态与远程文档向量对比转化为更新数据作为step2消息的消息体
      * 2.是step2消息，接收到的是远程文档的更新信息，与本地文档进行同步*/</span>
      <span class="token keyword">const</span> syncMessageType <span class="token operator">=</span> syncProtocol<span class="token punctuation">.</span><span class="token function">readSyncMessage</span><span class="token punctuation">(</span>decoder<span class="token punctuation">,</span> encoder<span class="token punctuation">,</span> provider<span class="token punctuation">.</span>doc<span class="token punctuation">,</span> provider<span class="token punctuation">)</span>
        <span class="token comment">//如果消息类型为step2类型，且来自远程，且消息已同步标识未设置为true则要把其设置为true，且尚未同步，则设置为已同步(因为上一行代码执行的就是同步操作)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>emitSynced <span class="token operator">&amp;&amp;</span> syncMessageType <span class="token operator">===</span> syncProtocol<span class="token punctuation">.</span>messageYjsSyncStep2 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>provider<span class="token punctuation">.</span>synced<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        provider<span class="token punctuation">.</span>synced <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">messageQueryAwareness</span><span class="token operator">:</span>
      encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> messageAwareness<span class="token punctuation">)</span>
      encoding<span class="token punctuation">.</span><span class="token function">writeVarUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> awarenessProtocol<span class="token punctuation">.</span><span class="token function">encodeAwarenessUpdate</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>awareness<span class="token punctuation">,</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>awareness<span class="token punctuation">.</span><span class="token function">getStates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token literal-property property">messageAwareness</span><span class="token operator">:</span>
      awarenessProtocol<span class="token punctuation">.</span><span class="token function">applyAwarenessUpdate</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>awareness<span class="token punctuation">,</span> decoding<span class="token punctuation">.</span><span class="token function">readVarUint8Array</span><span class="token punctuation">(</span>decoder<span class="token punctuation">)</span><span class="token punctuation">,</span> provider<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token literal-property property">messageAuth</span><span class="token operator">:</span>
      authProtocol<span class="token punctuation">.</span><span class="token function">readAuthMessage</span><span class="token punctuation">(</span>decoder<span class="token punctuation">,</span> provider<span class="token punctuation">.</span>doc<span class="token punctuation">,</span> permissionDeniedHandler<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;Unable to compute message&#39;</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> encoder
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> encoder
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@description</span> 初始化ws通信
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>WebsocketProvider<span class="token punctuation">}</span></span> <span class="token parameter">provider</span>
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">setupWS</span> <span class="token operator">=</span> <span class="token parameter">provider</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//不允许连接或未提供websocket实例则不执行连接程序</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span>shouldConnect <span class="token operator">&amp;&amp;</span> provider<span class="token punctuation">.</span>ws <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> websocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">provider<span class="token punctuation">.</span>_WS</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    websocket<span class="token punctuation">.</span>binaryType <span class="token operator">=</span> <span class="token string">&#39;arraybuffer&#39;</span>
    provider<span class="token punctuation">.</span>ws <span class="token operator">=</span> websocket
    provider<span class="token punctuation">.</span>wsconnecting <span class="token operator">=</span> <span class="token boolean">true</span>
    provider<span class="token punctuation">.</span>wsconnected <span class="token operator">=</span> <span class="token boolean">false</span>
    provider<span class="token punctuation">.</span>synced <span class="token operator">=</span> <span class="token boolean">false</span>

      <span class="token comment">//收到消息时</span>
    websocket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取国际时间</span>
      provider<span class="token punctuation">.</span>wsLastMessageReceived <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">getUnixTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//读取数据</span>
      <span class="token keyword">const</span> encoder <span class="token operator">=</span> <span class="token function">readMessage</span><span class="token punctuation">(</span>provider<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token comment">//不发送脏数据</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>encoding<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    websocket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      provider<span class="token punctuation">.</span>ws <span class="token operator">=</span> <span class="token keyword">null</span>
      provider<span class="token punctuation">.</span>wsconnecting <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span>wsconnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        provider<span class="token punctuation">.</span>wsconnected <span class="token operator">=</span> <span class="token boolean">false</span>
        provider<span class="token punctuation">.</span>synced <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token comment">// update awareness (all users except local left)</span>
        <span class="token comment">// 更新意识信息</span>
        awarenessProtocol<span class="token punctuation">.</span><span class="token function">removeAwarenessStates</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>awareness<span class="token punctuation">,</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>awareness<span class="token punctuation">.</span><span class="token function">getStates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">client</span> <span class="token operator">=&gt;</span> client <span class="token operator">!==</span> provider<span class="token punctuation">.</span>doc<span class="token punctuation">.</span>clientID<span class="token punctuation">)</span><span class="token punctuation">,</span> provider<span class="token punctuation">)</span>
        provider<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
          <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;disconnected&#39;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        provider<span class="token punctuation">.</span>wsUnsuccessfulReconnects<span class="token operator">++</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Start with no reconnect timeout and increase timeout by</span>
      <span class="token comment">// log10(wsUnsuccessfulReconnects).</span>
      <span class="token comment">// The idea is to increase reconnect timeout slowly and have no reconnect</span>
      <span class="token comment">// timeout at the beginning (log(1) = 0)</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span>setupWS<span class="token punctuation">,</span> math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token function">log10</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>wsUnsuccessfulReconnects <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> reconnectTimeoutBase<span class="token punctuation">,</span> maxReconnectTimeout<span class="token punctuation">)</span><span class="token punctuation">,</span> provider<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    websocket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//记录最近接收的消息的时间</span>
      provider<span class="token punctuation">.</span>wsLastMessageReceived <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">getUnixTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">//连接成功，设置connecting为false</span>
      provider<span class="token punctuation">.</span>wsconnecting <span class="token operator">=</span> <span class="token boolean">false</span>
      provider<span class="token punctuation">.</span>wsconnected <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token comment">//清空重连失败的次数</span>
      provider<span class="token punctuation">.</span>wsUnsuccessfulReconnects <span class="token operator">=</span> <span class="token number">0</span>
      provider<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;connected&#39;</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token comment">// always send sync step 1 when connected</span>
      <span class="token comment">// 连接成功时发送step1消息，将本地文档状态向量广播到其他客户端</span>
      <span class="token keyword">const</span> encoder <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> messageSync<span class="token punctuation">)</span>
      syncProtocol<span class="token punctuation">.</span><span class="token function">writeSyncStep1</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> provider<span class="token punctuation">.</span>doc<span class="token punctuation">)</span>
      websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// broadcast local awareness state</span>
      <span class="token comment">// 广播本地意识信息(通知他人我已经上线)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span>awareness<span class="token punctuation">.</span><span class="token function">getLocalState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> encoderAwarenessState <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoderAwarenessState<span class="token punctuation">,</span> messageAwareness<span class="token punctuation">)</span>
        encoding<span class="token punctuation">.</span><span class="token function">writeVarUint8Array</span><span class="token punctuation">(</span>encoderAwarenessState<span class="token punctuation">,</span> awarenessProtocol<span class="token punctuation">.</span><span class="token function">encodeAwarenessUpdate</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>awareness<span class="token punctuation">,</span> <span class="token punctuation">[</span>provider<span class="token punctuation">.</span>doc<span class="token punctuation">.</span>clientID<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoderAwarenessState<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    provider<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;connecting&#39;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>WebsocketProvider<span class="token punctuation">}</span></span> <span class="token parameter">provider</span>
 * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>ArrayBuffer<span class="token punctuation">}</span></span> <span class="token parameter">buf</span>
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">broadcastMessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">provider<span class="token punctuation">,</span> buf</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span>wsconnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// @ts-ignore We know that wsconnected = true</span>
    provider<span class="token punctuation">.</span>ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token comment">//发送消息</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span>bcconnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    provider<span class="token punctuation">.</span><span class="token function">mux</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      bc<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>provider<span class="token punctuation">.</span>bcChannel<span class="token punctuation">,</span> buf<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Websocket Provider for Yjs. Creates a websocket connection to sync the shared document.
 * The document name is attached to the provided url. I.e. the following example
 * creates a websocket connection to http://localhost:1234/my-document-name
 *
 * <span class="token keyword">@example</span>
 <span class="token example">*   <span class="token code language-javascript"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> <span class="token constant">Y</span> <span class="token keyword">from</span> <span class="token string">&#39;yjs&#39;</span></span>
 *   <span class="token code language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> WebsocketProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;y-websocket&#39;</span></span>
 *   <span class="token code language-javascript"><span class="token keyword">const</span> doc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Y<span class="token punctuation">.</span>Doc</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
 *   <span class="token code language-javascript"><span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebsocketProvider</span><span class="token punctuation">(</span><span class="token string">&#39;http://localhost:1234&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;my-document-name&#39;</span><span class="token punctuation">,</span> doc<span class="token punctuation">)</span></span>
 <span class="token code language-javascript"><span class="token operator">*</span></span></span>
 * <span class="token keyword">@extends</span> <span class="token class-name"><span class="token punctuation">{</span>Observable<span class="token punctuation">&lt;</span>string<span class="token punctuation">&gt;</span><span class="token punctuation">}</span></span>
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WebsocketProvider</span> <span class="token keyword">extends</span> <span class="token class-name">Observable</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">serverUrl</span> 服务地址
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>string<span class="token punctuation">}</span></span> <span class="token parameter">roomname</span> 房间名
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Y<span class="token punctuation">.</span>Doc<span class="token punctuation">}</span></span> <span class="token parameter">doc</span> 本地共享文档实例
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>object<span class="token punctuation">}</span></span> <span class="token optional-parameter"><span class="token punctuation">[</span><span class="token parameter">opts</span><span class="token punctuation">]</span></span>
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>boolean<span class="token punctuation">}</span></span> <span class="token optional-parameter"><span class="token punctuation">[</span><span class="token parameter">opts<span class="token punctuation">.</span>connect</span><span class="token punctuation">]</span></span> 是否连接
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>awarenessProtocol<span class="token punctuation">.</span>Awareness<span class="token punctuation">}</span></span> <span class="token optional-parameter"><span class="token punctuation">[</span><span class="token parameter">opts<span class="token punctuation">.</span>awareness</span><span class="token punctuation">]</span></span> 意识信息
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Object<span class="token punctuation">&lt;</span>string<span class="token punctuation">,</span>string<span class="token punctuation">&gt;</span><span class="token punctuation">}</span></span> <span class="token optional-parameter"><span class="token punctuation">[</span><span class="token parameter">opts<span class="token punctuation">.</span>params</span><span class="token punctuation">]</span></span> 请求携带的参数
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword">typeof</span> WebSocket<span class="token punctuation">}</span></span> <span class="token optional-parameter"><span class="token punctuation">[</span><span class="token parameter">opts<span class="token punctuation">.</span>WebSocketPolyfill</span><span class="token punctuation">]</span></span> Optionall provide a WebSocket polyfill 使用提供的websocket连接
   * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>number<span class="token punctuation">}</span></span> <span class="token optional-parameter"><span class="token punctuation">[</span><span class="token parameter">opts<span class="token punctuation">.</span>resyncInterval</span><span class="token punctuation">]</span></span> Request server state every `resyncInterval` milliseconds 每隔resyncInterval秒请求服务区
   */</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span>serverUrl<span class="token punctuation">,</span> roomname<span class="token punctuation">,</span> doc<span class="token punctuation">,</span> <span class="token punctuation">{</span> connect <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> awareness <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">awarenessProtocol<span class="token punctuation">.</span>Awareness</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">,</span> params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> WebSocketPolyfill <span class="token operator">=</span> WebSocket<span class="token punctuation">,</span> resyncInterval <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// ensure that url is always ends with / 确保服务器地址以/结尾</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>serverUrl<span class="token punctuation">[</span>serverUrl<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      serverUrl <span class="token operator">=</span> serverUrl<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> serverUrl<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//将携带的参数转化为查询字符串</span>
    <span class="token keyword">const</span> encodedParams <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">encodeQueryParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bcChannel <span class="token operator">=</span> serverUrl <span class="token operator">+</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> roomname
      <span class="token comment">//拼接地址</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> serverUrl <span class="token operator">+</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> roomname <span class="token operator">+</span> <span class="token punctuation">(</span>encodedParams<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&#39;&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;?&#39;</span> <span class="token operator">+</span> encodedParams<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>roomname <span class="token operator">=</span> roomname
    <span class="token keyword">this</span><span class="token punctuation">.</span>doc <span class="token operator">=</span> doc
    <span class="token keyword">this</span><span class="token punctuation">.</span>_WS <span class="token operator">=</span> WebSocketPolyfill
    <span class="token keyword">this</span><span class="token punctuation">.</span>awareness <span class="token operator">=</span> awareness
      <span class="token comment">//是否已连接</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wsconnected <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token comment">//是否连接中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wsconnecting <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token comment">//</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bcconnected <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token comment">//重连次数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wsUnsuccessfulReconnects <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token comment">//创建互斥锁</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mux <span class="token operator">=</span> mutex<span class="token punctuation">.</span><span class="token function">createMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 是否已同步
     * <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span>boolean<span class="token punctuation">}</span></span>
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_synced <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> websocket实例
     * <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span>WebSocket<span class="token operator">?</span><span class="token punctuation">}</span></span>
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ws <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token comment">//最近收到的消息时间</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>wsLastMessageReceived <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token doc-comment comment">/**
     * Whether to connect to other peers or not 是否连接到其他端点
     * <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span>boolean<span class="token punctuation">}</span></span>
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shouldConnect <span class="token operator">=</span> connect

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span>NodeJS<span class="token punctuation">.</span>Timeout <span class="token operator">|</span> number<span class="token punctuation">}</span></span>
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_resyncInterval <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token comment">//如果设置了定时请求</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resyncInterval <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_resyncInterval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ws<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// resend sync step 1</span>
          <span class="token keyword">const</span> encoder <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> messageSync<span class="token punctuation">)</span>
          syncProtocol<span class="token punctuation">.</span><span class="token function">writeSyncStep1</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> doc<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> resyncInterval<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * <span class="token keyword">@description</span> 收到来自其他Tab页的消息时
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>ArrayBuffer<span class="token punctuation">}</span></span> <span class="token parameter">data</span>
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">_bcSubscriber</span> <span class="token operator">=</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mux</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> encoder <span class="token operator">=</span> <span class="token function">readMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>encoding<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          bc<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bcChannel<span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * Listens to Yjs updates and sends them to remote peers (ws and broadcastchannel) 监听yjs共享文档的更新并同步数据到远程
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>Uint8Array<span class="token punctuation">}</span></span> <span class="token parameter">update</span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>any<span class="token punctuation">}</span></span> <span class="token parameter">origin</span>
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">_updateHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">update<span class="token punctuation">,</span> origin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//更新来源不是自身则编码发送该消息</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>origin <span class="token operator">!==</span> <span class="token keyword">this</span> <span class="token operator">||</span> origin <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//创建编码器</span>
        <span class="token keyword">const</span> encoder <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">//在编码器中写入消息类型</span>
        encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> messageSync<span class="token punctuation">)</span>
          <span class="token comment">//在编码器中写入消息数据</span>
        syncProtocol<span class="token punctuation">.</span><span class="token function">writeUpdate</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> update<span class="token punctuation">)</span>
          <span class="token comment">//广播消息</span>
        <span class="token function">broadcastMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>doc<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_updateHandler<span class="token punctuation">)</span>
    <span class="token doc-comment comment">/**
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>any<span class="token punctuation">}</span></span> <span class="token parameter">changed</span>
     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span>any<span class="token punctuation">}</span></span> <span class="token parameter">origin</span>
     */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">_awarenessUpdateHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> added<span class="token punctuation">,</span> updated<span class="token punctuation">,</span> removed <span class="token punctuation">}</span><span class="token punctuation">,</span> origin</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> changedClients <span class="token operator">=</span> added<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>removed<span class="token punctuation">)</span>
      <span class="token keyword">const</span> encoder <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> messageAwareness<span class="token punctuation">)</span>
      encoding<span class="token punctuation">.</span><span class="token function">writeVarUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> awarenessProtocol<span class="token punctuation">.</span><span class="token function">encodeAwarenessUpdate</span><span class="token punctuation">(</span>awareness<span class="token punctuation">,</span> changedClients<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token function">broadcastMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;beforeunload&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      awarenessProtocol<span class="token punctuation">.</span><span class="token function">removeAwarenessStates</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">,</span> <span class="token punctuation">[</span>doc<span class="token punctuation">.</span>clientID<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&#39;window unload&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    awareness<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_awarenessUpdateHandler<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_checkInterval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>wsconnected <span class="token operator">&amp;&amp;</span> messageReconnectTimeout <span class="token operator">&lt;</span> time<span class="token punctuation">.</span><span class="token function">getUnixTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wsLastMessageReceived<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// no message received in a long time - not even your own awareness</span>
        <span class="token comment">// updates (which are updated every 15 seconds)</span>
        <span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span>WebSocket<span class="token punctuation">}</span></span> */</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ws<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> messageReconnectTimeout <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span>boolean<span class="token punctuation">}</span></span>
   */</span>
  <span class="token keyword">get</span> <span class="token function">synced</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_synced
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">synced</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_synced <span class="token operator">!==</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_synced <span class="token operator">=</span> state
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;synced&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;sync&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">destroy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_resyncInterval <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span>NodeJS<span class="token punctuation">.</span>Timeout<span class="token punctuation">}</span></span> */</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_resyncInterval<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_checkInterval<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_awarenessUpdateHandler<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>doc<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">&#39;update&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_updateHandler<span class="token punctuation">)</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//连接到远程</span>
  <span class="token function">connectBc</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>bcconnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//订阅当前房间号的事件</span>
      bc<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bcChannel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_bcSubscriber<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>bcconnected <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// send sync step1 to bc 通过bc发送step1消息(这里用互斥锁保证了同一时刻只有一个同步程序在执行)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mux</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// write sync step 1</span>
        <span class="token comment">//创建编码器</span>
      <span class="token keyword">const</span> encoderSync <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//头部写入消息</span>
      encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoderSync<span class="token punctuation">,</span> messageSync<span class="token punctuation">)</span>
        <span class="token comment">//构建Step1消息，将当前文档的状态向量写入消息中</span>
      syncProtocol<span class="token punctuation">.</span><span class="token function">writeSyncStep1</span><span class="token punctuation">(</span>encoderSync<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>doc<span class="token punctuation">)</span>
        <span class="token comment">//通知其他选项卡当前的状态向量（同步数据）</span>
      bc<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bcChannel<span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoderSync<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// broadcast local state  广播本地状态</span>
      <span class="token keyword">const</span> encoderState <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoderState<span class="token punctuation">,</span> messageSync<span class="token punctuation">)</span>
      <span class="token comment">//创建Step2消息，将当前文档编码为更新消息</span>
      syncProtocol<span class="token punctuation">.</span><span class="token function">writeSyncStep2</span><span class="token punctuation">(</span>encoderState<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>doc<span class="token punctuation">)</span>
      <span class="token comment">//广播到其他选项卡  </span>
      bc<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bcChannel<span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoderState<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        
      <span class="token comment">//说实话我目前还没理解同时创建step1和step2的原因，因为不管是step1消息中的向量还是step2中的更新状态都可以用来完成数据同步。</span>
        
      
      <span class="token comment">// write queryAwareness 写入意识信息</span>
      <span class="token keyword">const</span> encoderAwarenessQuery <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">//这里广播了一个不附带消息体的messageQueryAwareness信息，我尚未理解其原因</span>
      encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoderAwarenessQuery<span class="token punctuation">,</span> messageQueryAwareness<span class="token punctuation">)</span>
      bc<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bcChannel<span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoderAwarenessQuery<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment">// broadcast local awareness state 广播本地的意识信息状态</span>
      <span class="token keyword">const</span> encoderAwarenessState <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoderAwarenessState<span class="token punctuation">,</span> messageAwareness<span class="token punctuation">)</span>
      encoding<span class="token punctuation">.</span><span class="token function">writeVarUint8Array</span><span class="token punctuation">(</span>encoderAwarenessState<span class="token punctuation">,</span> awarenessProtocol<span class="token punctuation">.</span><span class="token function">encodeAwarenessUpdate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>doc<span class="token punctuation">.</span>clientID<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      bc<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bcChannel<span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoderAwarenessState<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">disconnectBc</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// broadcast message with local awareness state set to null (indicating disconnect)</span>
    <span class="token comment">// 广播将本地意识状态设置为null(其实就是通知别人我下线了)</span>
    <span class="token keyword">const</span> encoder <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">createEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    encoding<span class="token punctuation">.</span><span class="token function">writeVarUint</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> messageAwareness<span class="token punctuation">)</span>
    encoding<span class="token punctuation">.</span><span class="token function">writeVarUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> awarenessProtocol<span class="token punctuation">.</span><span class="token function">encodeAwarenessUpdate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>awareness<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>doc<span class="token punctuation">.</span>clientID<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">broadcastMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">toUint8Array</span><span class="token punctuation">(</span>encoder<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bcconnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bc<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bcChannel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_bcSubscriber<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>bcconnected <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">disconnect</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shouldConnect <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">disconnectBc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ws <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">connect</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>shouldConnect <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>wsconnected <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ws <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setupWS</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connectBc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>上述源码代码过多同时涉及到yjs其他模块，我们梳理以下y-websocket的流程架构:</p><h3 id="初始化对象" tabindex="-1"><a class="header-anchor" href="#初始化对象" aria-hidden="true">#</a> 初始化对象</h3><p>类似大多数ws通信初始化方式，我们通过<code>new WebsocketProvider</code>来创建ws连接，yjs称其实例化对象为provider，我们后面也称其为provider。 初始化参数我上面都有注释，大部分很好理解，我们这只单独说一下<code>WebSocketPolyfill</code>这个参数。<a href="https://github.com/yjs/y-websocket" target="_blank" rel="noopener noreferrer">官网</a>对这个参数的解释是当在node环境下使用这个库时需要配置该参数。原因是浏览器环境下环境变量中有<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket" target="_blank" rel="noopener noreferrer">Websocket</a>这个对象了可以直接调用，node全局环境下没有这个对象所以需要额外提供，这个参数本质上就是一个<code>Websocket</code>对象(类)。以下是官网的代码实例:</p><p><code>const wsProvider = new WebsocketProvider(&#39;ws://localhost:1234&#39;, &#39;my-roomname&#39;, doc, { WebSocketPolyfill: require(&#39;ws&#39;) })</code></p><p>当然你硬要在浏览器环境下传也可以，就像下面这样： <code>const wsProvider = new WebsocketProvider(&#39;ws://localhost:1234&#39;, &#39;my-roomname&#39;, doc, { WebSocketPolyfill: Websocket })</code></p><p>初始化过程中会初始化一些属性，这些没什么好说的。其中有个<code>this.mux = mutex.createMutex()</code>属性，是在对象实例上创建了一个互斥锁。这个方法确保了同一时刻只有一个mux函数在执行，如下是<a href="https://www.npmjs.com/package/lib0" target="_blank" rel="noopener noreferrer">官网</a>的示例:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mutex <span class="token operator">=</span> <span class="token function">createMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">mutex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// This function is immediately executed 该函数将会立即执行</span>
  <span class="token function">mutex</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// This function is not executed, as the mutex is already active. 这个函数将不会被执行，因为有正在执行的mutx函数</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上图示例中在mutex函数内部调用的mutex函数是不会执行的，因为执行内部函数时外层的函数没还没执行结束，相当于被锁住了。</p><h3 id="初始化连接-connect" tabindex="-1"><a class="header-anchor" href="#初始化连接-connect" aria-hidden="true">#</a> 初始化连接(connect)</h3><p>初始化连接有两种方式，执行<code>new WebsocketProvider</code>时传递<code>connect</code>参数则会自动连接，否则需要手动调用<code>connect()</code>连接。</p><p>connect方法内部会首先调用setupWS方法构建websocket连接。</p><h4 id="setupws" tabindex="-1"><a class="header-anchor" href="#setupws" aria-hidden="true">#</a> setupWS</h4><ul><li>给websocket实力绑定<a href="#%E6%B4%BB%E5%8A%A8%E4%BA%8B%E4%BB%B6">活动事件</a></li><li>设置provider状态为连接中</li></ul><p>随后调用connectBc方法初始化本地跨标签页更新</p><h4 id="connectbc" tabindex="-1"><a class="header-anchor" href="#connectbc" aria-hidden="true">#</a> connectBc</h4><ul><li>订阅当前房间号的事件，当其他标签页修改时会触发该事件，通过获取该事件的参数即可实现本地跨标签同步。</li><li>通过y-protocol协议同步文档信息，同步意识信息</li></ul><h3 id="关闭连接-disconnect" tabindex="-1"><a class="header-anchor" href="#关闭连接-disconnect" aria-hidden="true">#</a> 关闭连接(disconnect)</h3><ul><li>设置shouldConnect为false</li><li>调用disconnectBC方法</li><li>关闭websocket连接</li></ul><h4 id="disconnectbc" tabindex="-1"><a class="header-anchor" href="#disconnectbc" aria-hidden="true">#</a> disconnectBc</h4><ul><li>通知其他人本机已离线</li><li>关闭标签页监听</li></ul><h3 id="活动事件" tabindex="-1"><a class="header-anchor" href="#活动事件" aria-hidden="true">#</a> 活动事件</h3><p>项目下的事件活动主要在这里处理。</p><h4 id="消息接受-onmessage" tabindex="-1"><a class="header-anchor" href="#消息接受-onmessage" aria-hidden="true">#</a> 消息接受(onmessage)</h4><ul><li>记录消息的接收时间</li><li>将数据实例化，开始读取信息 <ul><li>创建回复的消息(encoder)</li><li>判断信息的类型，意识信息或文档同步信息在这里区分</li><li>是文档同步信息。进入下层(y-protocol)协议 <ul><li>判断信息类型(step1/step2)</li><li>step1消息。消息主体为远程文档的状态向量，将该状态向量与本地文档状态比较生成更新数据并封装成step2类型的消息(encoder)</li><li>step2消息。消息主体为当前文档和发送方文档的差异数据，将这些差异同步到本地文档以实现文档状态同步。</li></ul></li><li>是意识信息 <ul><li>...</li></ul></li><li>是身份信息 <ul><li>...</li></ul></li><li>发送回复消息(encoder)</li></ul></li><li>回复消息数据为空则不发送数据，否则广播发送数据</li></ul><h4 id="连接成功-onopen" tabindex="-1"><a class="header-anchor" href="#连接成功-onopen" aria-hidden="true">#</a> 连接成功(onopen)</h4><ul><li>更新provider的状态为连接成功</li><li>创建step1消息，广播该消息到其他远程客户端 <ul><li>连接成功后发送step1消息必要性？事实上在初始化一个WebsocketProvider的时候，我们会传入一个doc，这个doc是从服务器获取的最新的文档状态。我觉得连接成功后发送一次step1主要还是为了能获取到最新的文档状态，因为这个文档可能正有其他用户在编辑中(最新的版本)，编辑中的文档会产生一些尚未持久化的差异，这些差异并不会立即同步到数据库中，而初始化中获取的初始文档数据大概率是从数据库中读取的文件，我们需要一次同步操作来使新加入的用户能立即获取到未持久化的最新编辑中。</li><li>广播意识信息，告诉其他用户我已上线</li></ul></li></ul><h4 id="连接关闭-onclose" tabindex="-1"><a class="header-anchor" href="#连接关闭-onclose" aria-hidden="true">#</a> 连接关闭(onclose)</h4><ul><li>清除websocket实例</li><li>清除自身以外的意识信息</li></ul><h3 id="usages" tabindex="-1"><a class="header-anchor" href="#usages" aria-hidden="true">#</a> Usages</h3><h4 id="status-event" tabindex="-1"><a class="header-anchor" href="#status-event" aria-hidden="true">#</a> status Event</h4><p>WebsocketProvider对象继承自lib0库的<a href="https://www.npmjs.com/package/lib0" target="_blank" rel="noopener noreferrer">Observable类</a>。这个类就是个订阅发布模式的实现，WebsocketProvider类内部触发status事件来暴露连接的状态。我们可以绑定响应的监听事件函数来处理连接状态的变化。</p><h4 id="synced-getter" tabindex="-1"><a class="header-anchor" href="#synced-getter" aria-hidden="true">#</a> synced Getter</h4><p>当该字段变化时，WebsocketProvider内部会触发<code>synced</code>和<code>sync</code>事件.同样可以绑定对应的监听函数来满足一些业务上的需求(比如，保存中？或者加载中？)</p></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg><a class="external-link meta-item-label" href="https://github.com/Renovamen/vuepress-theme-gungnir/edit/main/docs/posts/documents/yjs.js/y-websocket源码学习.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub"><!--[--><!--]--><!----><span>Edit this page on GitHub</span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/posts/documents/yjs.js/y-protocol%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0.html" class="" aria-label="y-protocol源码学习"><!--[--><!--]--><!----><span>y-protocol源码学习</span><!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--><!----></main><!--]--></div><div class="search-page" role="search"><span class="search-close"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 448 512" width="28" height="28" fill="currentColor"><path d="M224 416c-8.188 0-16.38-3.125-22.62-9.375l-192-192c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L224 338.8l169.4-169.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-192 192C240.4 412.9 232.2 416 224 416z"></path></svg></span><div class="gungnir-search-box"><input placeholder="$ grep ..." autocomplete="off" spellcheck="false" value><!----></div></div><div class="menu-btn-container"><div class="menu-btn-wrapper"><div class="menu-btn"><div style="" class="menu-btn-icon"><span></span><span></span><span></span></div><div style="display:none;" class="menu-text">0</div><svg class="menu-progress"><circle class="menu-border" cx="50%" cy="50%" r="48%" style="stroke-dasharray:0% 314.15926%;"></circle></svg></div><div class="menu-btn-child-wrapper"><div title="toggle color mode" class="menu-btn-child"><svg class="ov-icon" style="font-size:1.2em;display:none;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M256 160c-52.9 0-96 43.1-96 96s43.1 96 96 96 96-43.1 96-96-43.1-96-96-96zm246.4 80.5l-94.7-47.3 33.5-100.4c4.5-13.6-8.4-26.5-21.9-21.9l-100.4 33.5-47.4-94.8c-6.4-12.8-24.6-12.8-31 0l-47.3 94.7L92.7 70.8c-13.6-4.5-26.5 8.4-21.9 21.9l33.5 100.4-94.7 47.4c-12.8 6.4-12.8 24.6 0 31l94.7 47.3-33.5 100.5c-4.5 13.6 8.4 26.5 21.9 21.9l100.4-33.5 47.3 94.7c6.4 12.8 24.6 12.8 31 0l47.3-94.7 100.4 33.5c13.6 4.5 26.5-8.4 21.9-21.9l-33.5-100.4 94.7-47.3c13-6.5 13-24.7.2-31.1zm-155.9 106c-49.9 49.9-131.1 49.9-181 0-49.9-49.9-49.9-131.1 0-181 49.9-49.9 131.1-49.9 181 0 49.9 49.9 49.9 131.1 0 181z"/></svg><svg class="ov-icon" style="font-size:1.2em;display:none;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M283.211 512c78.962 0 151.079-35.925 198.857-94.792 7.068-8.708-.639-21.43-11.562-19.35-124.203 23.654-238.262-71.576-238.262-196.954 0-72.222 38.662-138.635 101.498-174.394 9.686-5.512 7.25-20.197-3.756-22.23A258.156 258.156 0 00283.211 0c-141.309 0-256 114.511-256 256 0 141.309 114.511 256 256 256z"/></svg><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M224 96l16-32 32-16-32-16-16-32-16 32-32 16 32 16 16 32zM80 160l26.66-53.33L160 80l-53.34-26.67L80 0 53.34 53.33 0 80l53.34 26.67L80 160zm352 128l-26.66 53.33L352 368l53.34 26.67L432 448l26.66-53.33L512 368l-53.34-26.67L432 288zm70.62-193.77L417.77 9.38C411.53 3.12 403.34 0 395.15 0c-8.19 0-16.38 3.12-22.63 9.38L9.38 372.52c-12.5 12.5-12.5 32.76 0 45.25l84.85 84.85c6.25 6.25 14.44 9.37 22.62 9.37 8.19 0 16.38-3.12 22.63-9.37l363.14-363.15c12.5-12.48 12.5-32.75 0-45.24zM359.45 203.46l-50.91-50.91 86.6-86.6 50.91 50.91-86.6 86.6z"/></svg></div><div class="menu-btn-child"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M207.029 381.476L12.686 187.132c-9.373-9.373-9.373-24.569 0-33.941l22.667-22.667c9.357-9.357 24.522-9.375 33.901-.04L224 284.505l154.745-154.021c9.379-9.335 24.544-9.317 33.901.04l22.667 22.667c9.373 9.373 9.373 24.569 0 33.941L240.971 381.476c-9.373 9.372-24.569 9.372-33.942 0z"/></svg></div><div class="menu-btn-child"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M240.971 130.524l194.343 194.343c9.373 9.373 9.373 24.569 0 33.941l-22.667 22.667c-9.357 9.357-24.522 9.375-33.901.04L224 227.495 69.255 381.516c-9.379 9.335-24.544 9.317-33.901-.04l-22.667-22.667c-9.373-9.373-9.373-24.569 0-33.941L207.03 130.525c9.372-9.373 24.568-9.373 33.941-.001z"/></svg></div><!----><div class="toggle-sidebar-button menu-btn-child menu-btn-sidebar" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-1.6 -1.6 19.2 19.2" fill="currentColor"><path d="M14 2a1 1 0 011 1v10a1 1 0 01-1 1H2a1 1 0 01-1-1V3a1 1 0 011-1h12zM2 1a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V3a2 2 0 00-2-2H2z"/><path d="M3 4a1 1 0 011-1h2a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V4z"/></svg></div></div></div></div><!----></div><!--]--></div>
    <script type="module" src="/assets/app.544e4f17.js" defer></script>
  </body>
</html>
